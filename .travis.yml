language: c

compiler:
  - gcc
  - clang

os:
  - linux
  - osx
  - windows

install:
  - |
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
        choco install cygwin cyg-get && \
        C:\\ProgramData\\chocolatey\\bin\\cyg-get.bat autoconf automake make gcc-core clang clang-analyzer git
    fi

script:
  - |
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
        STATUS=1

        if [[ "$CC" == "clang" ]]; then
            echo && \
            echo "----------------------- AUTORECONF --FORCE ------------------------" && \
            echo && \
            autoreconf --force && \
            echo && \
            echo "---------------------------- CONFIGURE ----------------------------" && \
            echo && \
            ./configure && \
            echo && \
            echo "------------------------------ MAKE -------------------------------" && \
            echo && \
            make "CFLAGS=-Werror" && \
            echo && \
            echo "--------------------------- MAKE CHECK ----------------------------" && \
            echo && \
            sudo make check "TESTS=tests/bwping" && \
            echo && \
            echo "------------------------- MAKE DISTCHECK --------------------------" && \
            echo && \
            sudo make distcheck "TESTS=tests/bwping" && \
            echo && \
            echo "------------------------- MAKE DISTCLEAN --------------------------" && \
            echo && \
            sudo make distclean && \
            echo && \
            echo "---------------------- SCAN-BUILD CONFIGURE -----------------------" && \
            echo && \
            scan-build ./configure && \
            echo && \
            echo "------------------------- SCAN-BUILD MAKE -------------------------" && \
            echo && \
            scan-build --status-bugs make "CFLAGS=-std=gnu99 -Werror"

            STATUS=$?
        else
            echo && \
            echo "----------------------- AUTORECONF --FORCE ------------------------" && \
            echo && \
            autoreconf --force && \
            echo && \
            echo "---------------------------- CONFIGURE ----------------------------" && \
            echo && \
            ./configure && \
            echo && \
            echo "------------------------------ MAKE -------------------------------" && \
            echo && \
            make "CFLAGS=-Werror" && \
            echo && \
            echo "--------------------------- MAKE CHECK ----------------------------" && \
            echo && \
            sudo make check "TESTS=tests/bwping" && \
            echo && \
            echo "------------------------- MAKE DISTCHECK --------------------------" && \
            echo && \
            sudo make distcheck "TESTS=tests/bwping"

            STATUS=$?
        fi

        if [[ -f config.log ]]; then
            echo
            echo "----------------------- BEGIN OF CONFIG.LOG -----------------------"
            echo

            cat config.log

            echo
            echo "------------------------ END OF CONFIG.LOG ------------------------"
            echo
        fi
        if [[ -f test-suite.log ]]; then
            echo
            echo "--------------------- BEGIN OF TEST-SUITE.LOG ---------------------"
            echo

            cat test-suite.log

            echo
            echo "---------------------- END OF TEST-SUITE.LOG ----------------------"
            echo
        fi

        exit $STATUS
    elif [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        echo && \
        echo "----------------------- AUTORECONF --FORCE ------------------------" && \
        echo && \
        autoreconf --force && \
        echo && \
        echo "---------------------------- CONFIGURE ----------------------------" && \
        echo && \
        ./configure && \
        echo && \
        echo "------------------------------ MAKE -------------------------------" && \
        echo && \
        make "CFLAGS=-Werror" && \
        echo && \
        echo "--------------------------- MAKE CHECK ----------------------------" && \
        echo && \
        sudo make check && \
        echo && \
        echo "------------------------- MAKE DISTCHECK --------------------------" && \
        echo && \
        sudo make distcheck

        STATUS=$?

        if [[ -f config.log ]]; then
            echo
            echo "----------------------- BEGIN OF CONFIG.LOG -----------------------"
            echo

            cat config.log

            echo
            echo "------------------------ END OF CONFIG.LOG ------------------------"
            echo
        fi
        if [[ -f test-suite.log ]]; then
            echo
            echo "--------------------- BEGIN OF TEST-SUITE.LOG ---------------------"
            echo

            cat test-suite.log

            echo
            echo "---------------------- END OF TEST-SUITE.LOG ----------------------"
            echo
        fi

        exit $STATUS
    elif [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
        GIT_REPO_URL="https://github.com/oleg-derevenetz/bwping.git"
        GIT_REPO_BRANCH="master"

        STATUS=1

        if [[ "$CC" == "clang" ]]; then
            mkdir -p "$TRAVIS_BUILD_DIR/_CYGWIN_" && \
            C:\\tools\\cygwin\\bin\\bash.exe -l -c " \
                echo && \
                echo \"------------------------------ SETUP ------------------------------\" && \
                echo && \
                export CC=\"$CC\" && \
                cd \"/cygdrive/$TRAVIS_BUILD_DIR/_CYGWIN_\" && \
                echo && \
                echo \"---------------------------- GIT CLONE ----------------------------\" && \
                echo && \
                git clone --depth=50 --branch=\"$GIT_REPO_BRANCH\" \"$GIT_REPO_URL\" . && \
                echo && \
                echo \"----------------------- AUTORECONF --FORCE ------------------------\" && \
                echo && \
                autoreconf --force && \
                echo && \
                echo \"---------------------------- CONFIGURE ----------------------------\" && \
                echo && \
                ./configure && \
                echo && \
                echo \"------------------------------ MAKE -------------------------------\" && \
                echo && \
                make \"CFLAGS=-Werror\" && \
                echo && \
                echo \"--------------------------- MAKE CHECK ----------------------------\" && \
                echo && \
                make check && \
                echo && \
                echo \"------------------------- MAKE DISTCHECK --------------------------\" && \
                echo && \
                make distcheck && \
                echo && \
                echo \"------------------------- MAKE DISTCLEAN --------------------------\" && \
                echo && \
                make distclean && \
                echo && \
                echo \"---------------------- SCAN-BUILD CONFIGURE -----------------------\" && \
                echo && \
                scan-build ./configure && \
                echo && \
                echo \"------------------------- SCAN-BUILD MAKE -------------------------\" && \
                echo && \
                scan-build --status-bugs make \"CFLAGS=-std=gnu99 -Werror\""

            STATUS=$?
        else
            mkdir -p "$TRAVIS_BUILD_DIR/_CYGWIN_" && \
            C:\\tools\\cygwin\\bin\\bash.exe -l -c " \
                echo && \
                echo \"------------------------------ SETUP ------------------------------\" && \
                echo && \
                export CC=\"$CC\" && \
                cd \"/cygdrive/$TRAVIS_BUILD_DIR/_CYGWIN_\" && \
                echo && \
                echo \"---------------------------- GIT CLONE ----------------------------\" && \
                echo && \
                git clone --depth=50 --branch=\"$GIT_REPO_BRANCH\" \"$GIT_REPO_URL\" . && \
                echo && \
                echo \"----------------------- AUTORECONF --FORCE ------------------------\" && \
                echo && \
                autoreconf --force && \
                echo && \
                echo \"---------------------------- CONFIGURE ----------------------------\" && \
                echo && \
                ./configure && \
                echo && \
                echo \"------------------------------ MAKE -------------------------------\" && \
                echo && \
                make \"CFLAGS=-Werror\" && \
                echo && \
                echo \"--------------------------- MAKE CHECK ----------------------------\" && \
                echo && \
                make check && \
                echo && \
                echo \"------------------------- MAKE DISTCHECK --------------------------\" && \
                echo && \
                make distcheck"

            STATUS=$?
        fi

        if [[ -f "$TRAVIS_BUILD_DIR/_CYGWIN_/config.log" ]]; then
            echo
            echo "----------------------- BEGIN OF CONFIG.LOG -----------------------"
            echo

            cat "$TRAVIS_BUILD_DIR/_CYGWIN_/config.log"

            echo
            echo "------------------------ END OF CONFIG.LOG ------------------------"
            echo
        fi
        if [[ -f "$TRAVIS_BUILD_DIR/_CYGWIN_/test-suite.log" ]]; then
            echo
            echo "--------------------- BEGIN OF TEST-SUITE.LOG ---------------------"
            echo

            cat "$TRAVIS_BUILD_DIR/_CYGWIN_/test-suite.log"

            echo
            echo "---------------------- END OF TEST-SUITE.LOG ----------------------"
            echo
        fi

        exit $STATUS
    fi
